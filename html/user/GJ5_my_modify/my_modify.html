<!--
 @filename    : my_modify.html
 @author      : 양수원 (ysw7939@gmail.com)
 @description : Grandjeju 내 정보 수정의 구조 구현
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrandJeju - 내 정보 수정</title>

    <link rel="stylesheet" href="../assets/css/all.css">
    <link rel="stylesheet" href="../assets/css/header_style.css">
    <link rel="stylesheet" href="assets/css/style_mymodify.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Rubik&display=swap" rel="stylesheet">
</head>
<body>
    <div id="wrap">
        <!-- HEADER -->
        <div id="header">
            <h2 class="title">내 정보 수정</h2>
        </div>
        <div id="container">
            <!-- form -->
            <form id="modify_form_group">
                <div class="modify_form">
                    <div class="modify_id_group">
                        <a>아이디</a>
                        <input type="text" class="modify_id" value="" disabled placeholder="">
                        <span class="error_text"></span>
                    </div>
                    <div class="modify_pw_group">
                        <a>비밀번호</a>
                        <input type="password" class="modify_pw">
                        <span class="error_text"></span>
                    </div>
                    <div class="modify_pw_re_group">
                        <a>비밀번호 확인</a>
                        <input type="password" class="modify_pw_re">
                        <span class="error_text"></span>
                    </div>
                    <div class="modify_name_group">
                        <a>이름</a>
                        <input type="text" class="modify_name">
                        <span class="error_text"></span>
                    </div>
                    <div class="modify_tel_group">
                        <a>휴대폰 번호</a>
                        <input type="tel" class="modify_tel">
                        <span class="error_text"></span>
                    </div>
                </div>
                <div class="button_wrap">
                    <button type="submit" class="modify_button">수정</button>
                    <button type="button" class="drop_button">회원탈퇴</button>
                </div>
            </form>
        </div>
    </div>

    
    <script src='https://unpkg.com/sweetalert/dist/sweetalert.min.js'></script>
    <script src='./assets/js/join_regex_helper.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src='./assets/js/my_info_modify.js'></script>

    <script>
        const drop = document.querySelector(".drop_button");
        drop.addEventListener("click", e =>{
            swal({
                text: "정말 탈퇴하시겠습니까?", // Alert 내용
                buttons: {
                    confirm: "OK",  // 확인 버튼
                    cancel: true    // 취소 버튼
                }
            }).then(() => {   // 확인 버튼 이벤트
                e.preventDefault();

                (async () => {
                    let json = null;

                    // 세션에 저장된 로그인 정보
                    try {
                        const response = await axios.get('/members/info');
                        json = response.data;
                    } catch (e) {
                        alert(e.response.data.rtmsg);
                        history.back();
                        return;
                    }

                    let member_id = json.item.member_id;

                    if (json != null) {
                        // 즉시실행 비동기 처리 함수
                        (async () => {
                            try {
                                // Ajax 요청 보내기 -> 백엔드가 전달한 결과값이 response.data에 저장된다.
                                const response = await axios.delete("/membersout/" + member_id);
                                
                                // 백엔드에서 전달된 결과가 로그인 성공을 의미하는 경우
                                alert("탈퇴가 완료되었습니다.");
                                (async () => {
                                    try {
                                        // Ajax 요청 보내기 -> 백엔드가 전달한 결과값이 response.data에 저장된다.
                                        const response = await axios.delete("/members/logout");
                                        
                                        // 백엔드에서 전달된 결과가 로그인 성공을 의미하는 경우
                                        location.href = "../GJ1_main_page/main.html"
                                    } catch (error) {
                                        const errorMsg = "[" + error.response.status + "] " + error.response.statusText
                                        console.error(errorMsg);
                                        alert("로그아웃에 실패했습니다. 잠시 후 다시 시도해 주세요.");
                                    }
                                })();
                            } catch (error) {
                                const errorMsg = "[" + error.response.status + "] " + error.response.statusText
                                console.error(errorMsg);
                                alert("회원 탈퇴에 실패했습니다. 잠시 후 다시 시도해 주세요.");
                            }
                        })();
                    };
                })();
            });
        });
    </script>
</body>
</html>