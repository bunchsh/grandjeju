<!--
 @filename    : my_modify.html
 @author      : 양수원 (ysw7939@gmail.com)
 @description : Grandjeju 내 정보 수정의 구조 구현
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrandJeju - 내 정보 수정</title>

    <link rel="stylesheet" href="../assets/css/all.css">
    <link rel="stylesheet" href="../assets/css/header_style.css">
    <link rel="stylesheet" href="assets/css/style_mymodify.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Rubik&display=swap" rel="stylesheet">
</head>
<body>
    <div id="wrap">
        <!-- HEADER -->
        <div id="header">
            <h2 class="title">내 정보 수정</h2>
        </div>
        <!-- form -->
        <form id="modify_form_group">
            <div class="modify_form">
                <div class="modify_id_group">
                    <a>아이디</a>
                    <input type="text" class="modify_id" value="" disabled placeholder="">
                    <span class="error_text"></span>
                </div>
                <div class="modify_pw_group">
                    <a>비밀번호</a>
                    <input type="password" class="modify_pw">
                    <span class="error_text"></span>
                </div>
                <div class="modify_pw_re_group">
                    <a>비밀번호 확인</a>
                    <input type="password" class="modify_pw_re">
                    <span class="error_text"></span>
                </div>
                <div class="modify_name_group">
                    <a>이름</a>
                    <input type="text" class="modify_name">
                    <span class="error_text"></span>
                </div>
                <div class="modify_tel_group">
                    <a>휴대폰 번호</a>
                    <input type="tel" class="modify_tel">
                    <span class="error_text"></span>
                </div>
            </div>
            <div class="button_wrap">
                <button type="submit" class="modify_button">수정</button>
                <button type="button" class="dorp_button">회원탈퇴</button>
            </div>
        </form>
    </div>
    <script src='https://unpkg.com/sweetalert/dist/sweetalert.min.js'></script>
    <script src='./assets/js/join_regex_helper.js'></script>
    <!-- <script src='./assets/js/my_info.js'></script> -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        (async () => {
            let json = null;

            // 세션에 저장된 로그인 정보
            try {
                const response = await axios.get('/memberstest/info');
                json = response.data;
            } catch (e) {
                alert(e.response.data.rtmsg);
                history.back();
                return;
            }

            console.log(json.item);

            if (json != null) {

                (async () => {
                    /** 입력을 위한 input 태그 객체 */
                    const inputUserid = document.querySelector(".modify_id");
                    const inputPw = document.querySelector(".modify_pw");
                    const inputName = document.querySelector(".modify_name");
                    const inputUserphone = document.querySelector(".modify_tel");

                    if (!json.item.member_id) {
                        alert('회원 정보가 없습니다.');
                        return;
                    }

                    /** 수정 form에 기존의 데이터를 표시하기 위해 Ajax로 저장된 데이터를 조회해야 함 */
                    let json2 = null;
                    let member_id = json.item.member_id;

                    try {
                        const response = await axios.get('/members/' + member_id);
                        json2 = response.data;
                    } catch (e) {
                        alert(e.response.data.rtmsg);
                        return;
                    }

                    // 조회 결과가 있다면 input 태그에 조회 데이터 세팅
                    if (json2 != null) {
                        console.log(json2.item[0]);
                        inputUserid.value = json2.item[0].user_id;
                        inputPw.value = json2.item[0].user_pw;
                        inputName.value = json2.item[0].user_name;
                        inputUserphone.value = json2.item[0].user_phone;
                    }

                })();

                /** 수정 완료 후, submit 이벤트가 발생한 경우 */
                document.querySelector("#modify_form_group").addEventListener("submit", async (e) => {
                    e.preventDefault();
    
                    // 입력값 받아오기
                    const inputUserid = document.querySelector(".modify_id").value;
                    const inputPw = document.querySelector(".modify_pw").value;
                    const inputName = document.querySelector(".modify_name").value;
                    const inputUserphone = document.querySelector(".modify_tel").value;
    
                    // 입력값에 대한 유효성 검사 진행 (생략)
    
                    let json3 = null;
                    let member_id = json.item.member_id;
                    console.log(member_id);
    
                    try {
                        const response = await axios.put("/memberstest/" + member_id, {
                            inputUserid: user_id,
                            inputPw: user_pw,
                            inputName: user_name,
                            inputUserphone: user_phone
                        });
    
                        json3 = response.data;
                    } catch (e) {
                        alert(e.response.data.rtmsg);
                        return;
                    }

                    if (json3 != null) {
                        console.log(json3);
                        alert('수정이 완료되었습니다!');
                        window.location = "/GJ4_my_page/my.html"
                    }
                });
            }

        })();
    </script>
    
</body>
</html>