<!--
 @filename    : review_write.html
 @author      : 한송희 (onee.ssong@gmail.com)
 @description : Grandjeju REVEIW 작성 페이지의 구조 구현
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrandJeju - REVIEW 작성</title>

    <link rel="stylesheet" href="../assets/css/all.css">
    <link rel="stylesheet" href="../assets/css/header_style.css">
    <link rel="stylesheet" type="text/css" href="./assets/css/style_review.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Rubik&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/b718907b8f.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
</head>

<body>
    <div id="wrap">
        <!-- HEADER -->
        <div id="header">
            <h2 class="title">REVIEW 작성</h2>
        </div>

        <!-- CONTAINER -->
        <div id="container">

            <!-- CONTENT -->
            <div id="content">
                <form id="review_write">
                    <!-- 제목 항목 -->
                    <div class="title_group">
                        <input class="title_input" id="title" type="text" placeholder="제목">
                    </div>
                    <!-- 본문 항목 -->
                    <div class="editor_group">
                        <div id="editor"></div>
                    </div>
                    <!-- 버튼 -->
                    <div class="btn_group">
                        <button type="submit" class="btn_write">등록</button>
                    </div>
                    <div class="upload_group">
                        <label for="photo_img">이미지
                            <i class="fa-solid fa-images"></i>
                        </label> 
                        <input type='file' name='photo_img' multiple id='photo_img'/>
                    </div>
                </form>
            </div>
        </div>
        <div id="console"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src='https://unpkg.com/sweetalert/dist/sweetalert.min.js'></script>
    <script src="./assets/js/write_regex_helper.js"></script>
    <script>
        const Editor = toastui.Editor;
        const editor = new Editor({
            el: document.querySelector('#editor'),
            height: '500px',
            initialEditType: 'html',
            previewStyle: 'vertical'
        });
    

    
        document.querySelector('#review_write').addEventListener("submit", e => {
            e.preventDefault();
            console.log(editor.getHTML);

            const regexHelper = new RegexHelper();

            /** 제목 검사 */
            if (!regexHelper.value(".title_input", "제목이 입력되지 않았습니다.")) { return false; }
            /** 내용 검사 */
            if (!regexHelper.editor_value(editor.getHTML(), "내용이 입력되지 않았습니다.")) { return false; }

        });
    </script>
    <script>
        let id_array = []
        document.querySelector('#photo_img').addEventListener('change', async (e) => {
            const files = e.target.files;
            const keys = Object.keys(files);

            // 현제 에디터의 작성 내용 저장
            let get_editor = editor.getHTML()

            console.log(get_editor);
            console.log(files)

            // javascript로 가상의 form을 생성
            const form = new FormData();
            // 가상의 폼에 input요소 추가
            form.append('photo_img', files[0]);
            

            keys.forEach((i, v) => {
                // javascript로 가상의 form을 생성
                const form = new FormData();
                // 가상의 폼에 input요소 추가
                form.append('photo_img', files[v]);
                
                (async () => {
                    try {
                        const response = await axios.post("/photo", form);
                        console.log(response.data);
                        json = response.data

                        
                        keys.forEach(v => {
                            console.log(get_editor);
                            
                            // 기존 에디터의 작성내용 + 새로 추가된 이미지
                            editor.setHTML(`${get_editor}<img src='${json.item[0].path}'/>`);

                            // 파일 테이블에 저장된 pk값 배열로 저장
                            id_array.push(json.item[0].photo_id)
                        });


                    } catch (error) {
                        console.error(error);
                    }
                })();
            });
        })
    </script>
    <script>
        document.querySelector('#review_write').addEventListener("submit", async(e) => {
            e.preventDefault();

            const user_name = "양수원"
            const user_id = "ysw7939"
            const title = document.querySelector("#title").value;
            const text = editor.getHTML();

            let json = null;
            let up = null;
            try { 
                const response = await axios.post("/review", {
                    user_name : user_name,
                    user_id : user_id,
                    title : title,
                    text : text
                });
                json = response.data;

                id_array.forEach(async (v, i) => {
                    const updated = await axios.put("/photo/" + v ,{
                        review_id : json.item[0].review_id
                    });
                    up = updated.data;
                })
                
            } catch (e) {
                alert(e.response.data.rtmsg);
                return;
            }
            if(json != null) {
                window.location ="/GJ19_review_datail_page/review_detail.html?review_id=" + json.item[0].review_id;
            }
        })
    </script>
</body>

</html>