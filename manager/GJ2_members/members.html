<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/memvers.css">
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: black;">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#"><img src='assets/img/logo.png' width="50" height="50"></a>
                </div>
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" aria-current="page" href="#">회원관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">예약관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">리뷰관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">1:1 문의관리</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item ">
                        <a class="nav-link" href="#">logout</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <div class="container">
        <div class="float-left">
            <h3 class="my_h3">회원 관리</h3>
            <hr/>
        </div>

    <div class="container">
        <div class="clearfix">
            <div class="float-right">
                <div class="btn-group float-right my_margin">
                    <span class="my_border">총회원수</span></h4>
                    <span class="my_count" id="count"></span>
                </div>
                <form class="my_margin" id="form_serch" method="get" action="">
                    <div class="input-group" style="width: 400px;">
                        <select id="search" name="search" class="user-select-auto" style="width:120px;">
                            <option value="user_id">회원아이디</option>
                            <option value="user_name">이름</option>
                            <option value="user_phone">연락처</option>
                        </select>
                        <input type="search" name="query" class="form-control" id="query">
                        <span class="input-group-prepend">
                            <button type="submit" class="btn btn-dark"><i class="bi bi-search text-white"></i></button>
                        </span>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">번호</th>
                    <th scope="col">아이디</th>
                    <th id="order_btn"scope="col">이름 </th>
                    <th scope="col">휴대폰 번호</th>
                    <th scope="col">가입 날짜</th>
                    <th scope="col">관리</th>
                </tr>
            </thead>
            <tbody id="listBody">
            </tbody>
            </table>
    </div>

    <div class="text-center">
        <ul class="pagination justify-content-center">
        </ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script>
        Handlebars.registerHelper('inc', function (index) {
            index++;
            return index;
        });
    </script>
    <script id="members-list-template" type="text/x-handlebars-template">
        
        {{#each item}}
            <tr>
                <th scope="row">{{inc @index}}</th>
                <td>{{user_id}}</td>
                <td>{{user_name}}</td>
                <td>{{user_phone}}</td>
                <td>{{reg_date}}</td>
                <td>
                    <a href="/myschool/members/view.html?member_id={{member_id}}" class="btn btn-success btn-xs btn-edit">수정</a>
                    <a href="#" class="btn btn-danger btn-xs btn-delete" data-member_id="{{member_id}}" data-name="{{name}}">삭제</a>
                </td>
            </tr>
        {{/each}}
    </script>
    
    <script>
        /** GET 파라미터 받기 */
        const params = new URLSearchParams(window.location.search);
        const query = params.get('query') || "";
        const page = params.get('page') || 1;
        const search = params.get('search') || 'user_id';
        const order = params.get('order')

        // 검색어 파라미터를 input 태그에 설정된
        document.querySelector('#query').value = query;
        document.querySelector('#search').value = search;

        (async () => {
            // ajax 결과가 저장될 json
            let json = null;
            // 총 회원수
            let total_count = null;

            // ajax 요청
            try {
                const response = await axios.get('/members', {
                    params: {
                        query: query,
                        page: page,
                        search: search,
                        order: order
                    }
                });
                const total = await axios.get('/members')
                json = response.data
                total_count = total.data.pagenation.totalCount
                console.log(json);
            } catch (e) {
                // 에러가 발생한 경우 백엔드가 주는 json 받기
                const data = e.response.data;
                alert("[" + data.rt + "] " + data.rtmsg);
            }

            // ajax결과가 존재한다면?
            if (json != null) {
                console.log(json.pagenation);
                const source = document.querySelector("#members-list-template").innerHTML;
                const template = Handlebars.compile(source);
                const html = template(json);

                document.querySelector("#listBody").insertAdjacentHTML('beforeend', html);
                document.querySelector("#count").innerHTML = total_count+"명";

                // 삭제 버튼에 대한 이벤트 처리
                const btnDelete = document.querySelectorAll(".btn-delete");

                btnDelete.forEach((v, i) => {
                    v.addEventListener("click", async e => {
                        e.preventDefault();

                        // 클릭된 버튼 자신
                        const current = e.currentTarget;

                        // 클릭된 버튼에 숨겨진 data속성값들을 가져온다.
                        const member_id = current.dataset.member_id;
                        const user_name = current.dataset.user_name;
                        //console.log("%s, %s", deptno, dname);

                        if(confirm('정말' + user_name + '(을)를 삭제하시겠습니까?')){
                            // Ajax를 통한 삭제 처리
                            try {
                                const url = '/members/' + member_id;
                                await axios.delete(url);
                            } catch (e) {
                                // 에러가 발생한 경우 벡엔드가 주는 json 받기
                                const data = e.response.data;
                                alert("[" + data.rt + "]" + data.rmsg);
                                return;
                            }
                            // Ajax를 통한 삭제 요청에 성공했다면, 삭제된 항목을 HTML에서 제거해야 한다.
                            current.closest('tr').remove();
                        }
                    });
                });
                
                /** 페이지번호 구형 한수 호출하기 */
                // --> 페이지번호 HTML이 출력될 위치에 대한 selector와 페이지 번호 구현에 필요한 정보 전달
                pagenation(".pagination", json.pagenation);
                order_btn(decodeURIComponent(location.href),order);
            }
        })();
        /** 페이지 번호 구현 함수 */
        function pagenation(selector, data){
            // 페이지 번호가 출력될 대상
            const container = document.querySelector(selector);

            // 1) 이전 그룹 링크 : <li class="page-item"><a class="page-link" href="#">&laquo;</a><li>
            const li1 = document.createElement("li");
            li1.classList.add("page-item");

            const a1 = document.createElement("a");
            a1.innerHTML = "&laquo;";
            a1.classList.add("page-link");
            a1.setAttribute("href", "/GJ2_members/members.html?page=" + data.prevGroupLastPage + "&query=" + query);

            if(!(order == null)){
                    a1.setAttribute("href", "/GJ2_members/members.html?page=" + data.prevGroupLastPage + "&query=" + query +  "&order=" + order)
                }

            if(data.prevGroupLastPage == 0){
                li1.classList.add('disabled');
                a1.removeAttribute('href');
            }

            li1.appendChild(a1);
            container.appendChild(li1);

            // 2) 페이지번호 링크들 : <li class="page-item"><a class="page-link" href="#">3</a><li>
            for (let i=data.groupStart; i <= data.groupEnd; i++) {
                const li2 = document.createElement("li");
                li2.classList.add('page-item');

                const a2 = document.createElement("a");
                a2.innerHTML = i;
                a2.classList.add('page-link');
                a2.setAttribute("href", "/GJ2_members/members.html?page=" + i + "&query=" + query);

                if (!(order == null)) {
                    a2.setAttribute("href", "/GJ2_members/members.html?page=" + i + "&query=" + query + "&order=" + order);
                }

                if(data.nowPage == i) {
                    li2.classList.add('active');
                }

                li2.appendChild(a2);
                container.appendChild(li2);
            }

            // 3) 다음 그룹 링크 : <li class="page-item"><a class="page-link" href="#">&raquo;</a><li>
            const li3 = document.createElement("li");
            li3.classList.add("page-item");

            const a3 = document.createElement("a");
            a3.innerHTML = "&raquo;";
            a3.classList.add("page-link");
            a3.setAttribute("href", "/GJ2_members/members.html?page=" + data.nextGroupFirstPage + "&query=" + query);
            
            if (!(order == null)) {
                a3.setAttribute("href", "/GJ2_members/members.html?page=" + data.nextGroupFirstPage + "&query=" + query + "&order=" + order);
            }
            

            if(data.nextGroupFirstPage == 0){
                li3.classList.add('disabled');
                a3.removeAttribute('href');
            }

            li3.appendChild(a3);
            container.appendChild(li3);
        }

        // 내림차순 버튼
        function order_btn(data, order) {
            const btn_a = document.createElement("a")
            btn_a.setAttribute("id","order_a")
            btn_a.classList.add("btn");
            btn_a.classList.add("btn-dark");
            
            const icon = document.createElement("i")
            icon.classList.add("bi");
            icon.classList.add("bi-sort-alpha-down");

            if(data.indexOf("order") == -1) {
                btn_a.setAttribute("href",data + "&order=asc")
            }

            if(order == 'asc' ) {
                btn_a.setAttribute("href",data.substring(0,data.indexOf('asc')) + "desc");
                icon.classList.replace("bi-sort-alpha-down","bi-sort-alpha-up-alt" );
            }
            if(order == 'desc'){
                btn_a.setAttribute("href",data.substring(0,data.indexOf('desc')) + "asc");
                icon.classList.replace("bi-sort-alpha-up-alt" ,"bi-sort-alpha-down");
            }

            btn_a.appendChild(icon);
            document.querySelector('#order_btn').appendChild(btn_a)
        }

    </script>
</body>
</html>